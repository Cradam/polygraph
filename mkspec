#!/usr/bin/env ruby -rjson

class Dot
  attr_accessor :raw
  def initialize path
    @raw = File.read(path)
  end
  def nodes
    @raw.lines
        .map { |x| x.match /(?<=label=")[^"]+/ }
        .compact
        .map { |x| x[0] }
  end
  def connections
    @raw.lines
        .map { |x| x.match /(\w+) -- (\w+) \[color=(\w+)\]/ }
        .compact
        .map { |x| x[1..3] }
  end
end

class Specification
  def initialize dot
    @dot = dot
  end
  def to_js
    json = { nodes: @dot.nodes,
      connections: @dot.connections
    }.to_json
    return ['var spec=', json].join
  end
end

spec = Specification.new Dot.new('./src/harem.dot')
File.open('spec.js', 'w') { |file| file.write spec.to_js }
